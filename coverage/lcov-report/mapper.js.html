<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for mapper.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> mapper.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.15% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>53/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.68% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>38/41</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>18/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.08% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>51/52</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28x</span>
<span class="cline-any cline-yes">28x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28x</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28x</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-yes">28x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">428x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">428x</span>
<span class="cline-any cline-yes">428x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2312x</span>
<span class="cline-any cline-yes">2312x</span>
<span class="cline-any cline-yes">2312x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">428x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44x</span>
<span class="cline-any cline-yes">264x</span>
<span class="cline-any cline-yes">264x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">244x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">244x</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-yes">54x</span>
<span class="cline-any cline-yes">34x</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">18x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">18x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { parse as parseHtml } from 'parse5'
import { parse as parseJs } from 'esprima'
import { generate } from 'escodegen'
import deepsearch from './deepsearch'
import traverse from './traverse'
&nbsp;
/**
 * entry point for dependency mapper
 * @param {object} angular - angular object
 * @param {array&lt;string&gt;} modules - list of module names to analyze
 * @param {regex} dependencyFilter - filter to exclude 3rd party dependencies
 * @return {array} list of application dependencies
 */
export default (angular, modules, dependencyFilter = /./g) =&gt; new Promise((resolve, reject) =&gt; {
  const dependencies = modules
    .reduce((acc, moduleName) =&gt; reduceModules(acc, moduleName, angular, dependencyFilter), [])
    .map(mapDependencies)
    .map(mapDependers)
  resolve(dependencies)
})
&nbsp;
/**
 * reduce callback
 * @param {array} acc - accumulator, should be array of objects
 * @param {string} moduleName - name of angular module
 * @return {array} reduce accumulator
 */
function reduceModules(acc, moduleName, angular, dependencyFilter) {
  const { _invokeQueue, _configBlocks, _runBlocks, requires } = angular.module(moduleName)
  const configBlocks = _configBlocks.reduce((list, args) =&gt; {
    const res = reduceConfigBlocks(moduleName, 'config', args[2][0])
    return res ? [ ...list, res ] : <span class="branch-1 cbranch-no" title="branch not covered" >list</span>
  }, [])
  const invokes = _invokeQueue.reduce((list, args) =&gt; {
    const res = reduceInvokeQueue(moduleName, args[1], args[2][0], args[2])
    return res ? [ ...list, res ] : list
  }, [])
  // each required module can be used with angular.module() to get nested dependency tree
  const moduleDependencies = requires
    .filter(name =&gt; dependencyFilter.test(name))
    .reduce((list, dependencyName) =&gt; reduceModules(list, dependencyName, angular, dependencyFilter), [])
  return [
    ...acc,
    ...configBlocks,
    ...invokes,
    ...moduleDependencies
  ]
}
&nbsp;
/**
 * map callback
 * @param {object} obj - generated from reduceModules
 * @param {number} index - position from list generated by reduceModules
 * @param {array} list - reduceModules return array
 * @return {object} object with dependency array, each item in array is list array index
 */
function mapDependencies(obj, index, list) {
  if (/component|directive/.test(obj.type)) {
    // todo: if templateUrl, Promise.props request and then parse response
    const htmlAst = parseHtml(obj.definition.template)
    // for each node, find matching elements by index in entire list
    const dependencies = traverse(htmlAst)((acc, node) =&gt; {
      // need to match nodename for restrict E
      const nodeName = node.nodeName.toLowerCase().replace(/-/g, '')
      // or filters attrs for restrict A
      const attrKeys = (node.attrs || []).map(a =&gt; a.name.toLowerCase().replace(/-/g, ''))
      const mappedIndices = list.reduce((acc, o, i) =&gt; {
        // run, config, value, etc. are not registered with a name
        const componentName = (o.name || '').toLowerCase()
        const hasDependency = nodeName === componentName || attrKeys.indexOf(componentName) &gt; -1
        return hasDependency ? [ ...acc, i ] : acc
      }, [])
      return [ ...acc, ...mappedIndices ]
    })
    return { ...obj, dependencies }
  } else {
    return obj
  }
}
&nbsp;
/**
 * goes back through list and maps depender objects
 * @param {object} obj - generated from reduceModules
 * @param {number} index - position from list generated by reduceModules
 * @param {array} list - reduceModules return array
 * @return {object} object with dependers array, each item in array is list array index
 */
function mapDependers(obj, index, list) {
  const dependers = list.reduce((acc, o, i) =&gt; {
    const isDependedOn = (o.dependencies || []).indexOf(index) &gt; -1
    return !isDependedOn ? acc : [ ...acc, i]
  }, [])
  return { ...obj, dependers }
}
&nbsp;
/**
 * Finds all registered angular services for given module
 *
 * @param {string} moduleName - name of module
 * @param {string} type - type of service
 * @param {name} type - name of service
 * @param {arguments} ...args - original arguments supplied to service
 * @return {array} list of services registered to module
 *   @property {string} module - name of parent module
 *   @property {string} type - type of angular service
 *   @property {string} definition - config function definition
 */
&nbsp;
// todo: this needs to be single obj in array, but have multiple definitions
function reduceConfigBlocks(moduleName, type, definition) {
  const templateRegex = /^template(url)?$/i
  const ast = parseJs(definition.toString())
  const stub = deepsearch(ast)((node) =&gt; {
    <span class="missing-if-branch" title="else path not taken" >E</span>if (node) {
      // todo: too optimistic, user might be defining via dot notation
      if (node.type === 'ObjectExpression') {
        if (node.properties.find(n =&gt; templateRegex.test(n.key.name))) {
          return node
        }
      }
    }
  })
  // ehhh....
  const code = !stub ? {} : new Function(`return ${generate(stub)}`)()
  return { module: moduleName, type, definition: code }
}
&nbsp;
/**
 * Finds all registered angular services for given module
 *
 * @param {string} moduleName - name of module
 * @param {string} type - type of service
 * @param {name} type - name of service
 * @param {arguments} ...args - original arguments supplied to service
 * @return {array} list of services registered to module
 *   @property {string} module - name of parent module
 *   @property {string} type - type of angular service
 *   @property {string} name - name of the service
 *   @property {string} definition - if component, directive, or value, the returned object literal
 */
function reduceInvokeQueue(moduleName, type, name, ...args) {
  const definition = args[0][1]
  const base = { type, name, module: moduleName }
  const isComponent = type === 'component'
  const isDirective = type === 'directive'
  if (isComponent)
    return { ...base, definition }
  else if (isDirective &amp;&amp; typeof definition === 'function')
    return { ...base, definition: definition() }
  else <span class="missing-if-branch" title="if path not taken" >I</span>if (isDirective &amp;&amp; definition.length === 1)
<span class="cstat-no" title="statement not covered" >    return { ...base, definition: definition[0]() }</span>
  else if (isDirective &amp;&amp; definition.length &gt; 1)
    return { ...base, definition: definition.slice(-1).pop()(definition.slice(0, -1)) }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Mar 15 2017 17:16:36 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
